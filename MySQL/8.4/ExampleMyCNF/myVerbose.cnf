
# =============================================================================
# my.cnf - MySQL 8.4 LTS
# Servidor: ALESC - Novo servidor MySQL 8.4 | RHEL 9.7
# Hardware: 16 GiB RAM | Storage: SSD/NVMe
# Estrutura de discos:
#   Disk 2 (200GB) → /mysql/data
#   Disk 3 (50GB)  → /mysql/innodb/{redo,undo,doublewrite}
#   Disk 4 (50GB)  → /mysql/innodb/temp
#   Disk 5 (50GB)  → /mysql/audit
#   Disk 6 (50GB)  → /mysql/log  (binlog + errorlog)
#   Disk 7 (50GB)  → /mysql/dump/securefile + /mysql/scripts
# =============================================================================

[mysqld]
# =============================================================================
# CORE / PATHS - DIRETÓRIOS E ARQUIVOS BASE
#
# basedir: raiz da instalação binária (tarball extraído).
#   Ao extrair o tarball em /mysql/mysql/, a estrutura criada é:
#   /mysql/mysql/bin/         ← executáveis (mysqld, mysql, mysqladmin...)
#   /mysql/mysql/lib/plugin/  ← plugins (.so)
#   /mysql/mysql/share/       ← mensagens de erro localizadas, SQL de timezone
#   /mysql/mysql/include/     ← headers C
#   Esses arquivos ficam no filesystem raiz (sda), não nos discos de dados.
#
# lc_messages_dir: diretório das mensagens de erro localizadas.
#   Combinado com lc_messages (default: en_US), o MySQL busca o arquivo:
#   /mysql/mysql/share/english/errmsg.sys
#   Em instalação binária deve ser declarado explicitamente para não usar
#   os paths padrão do sistema (/usr/share/mysql/).
# =============================================================================
basedir                         = /mysql/mysql
datadir                         = /mysql/data
#innodb_data_home_dir           = /mysql/data
pid-file                        = /run/mysqld/mysqld.pid
socket                          = /mysql/data/mysql.sock
plugin_dir                      = /mysql/mysql/lib/plugin
lc_messages_dir                 = /mysql/mysql/share

# =============================================================================
# INNODB PATHS
# Atenção: innodb_undo_directory, innodb_log_group_home_dir e
# innodb_doublewrite_dir devem ser definidos ANTES do primeiro --initialize.
# NÃO podem ser alterados de caminho posteriormente sem procedimento de recovery.
# Expansão do volume/disco subjacente é segura e transparente ao MySQL.
# =============================================================================

innodb_directories              = /mysql/data:/mysql/innodb:/mysql/innodb/temp  # Lista de diretórios que o InnoDB varre no startup para localizar tablespaces (.ibd) fora do datadir. Incluir apenas diretórios com tablespace files.

# Os redo log files ficam em {innodb_log_group_home_dir}/#innodb_redo/ (MySQL 8.0.30+)
innodb_log_group_home_dir       = /mysql/innodb/redo
innodb_redo_log_capacity        = 4G                            # Capacidade total do redo log. Substitui innodb_log_file_size + innodb_log_files_in_group (desde 8.0.30)

innodb_undo_directory           = /mysql/innodb/undo            # Undo tablespaces (undo_001, undo_002) criados durante mysqld --initialize

innodb_doublewrite_dir          = /mysql/innodb/doublewrite     # Arquivos do doublewrite buffer (desde MySQL 8.0.20) — isolado para reduzir I/O concorrente com dados
innodb_doublewrite              = 1                             # [default=ON] Doublewrite buffer habilitado — documentado explicitamente

innodb_tmpdir                   = /mysql/innodb/temp            # Arquivos temporários de operações DDL online
innodb_temp_tablespaces_dir     = /mysql/innodb/temp            # Session temporary tablespaces (MySQL 8.0+)
tmpdir                          = /mysql/innodb/temp            # Diretório para arquivos temporários gerais do MySQL
innodb_temp_data_file_path      = /mysql/innodb/temp/ibtmp1:12M:autoextend:max:10G  # Global temp tablespace — autoextend com limite de 10G

# =============================================================================
# CHARACTER SET / COLLATION
# =============================================================================
character_set_server            = utf8mb4
collation_server                = utf8mb4_general_ci

# =============================================================================
# CONEXÃO E SEGURANÇA
# Nota: server-id definido aqui pois é pré-requisito para GTID (seção abaixo),
# mesmo sem replicação ativa neste momento. Deve ser único por servidor.
# =============================================================================
server-id                       = 1
user                            = mysql
port                            = 3306
default_storage_engine          = innodb                        # [default=InnoDB] documentado explicitamente
max_allowed_packet              = 64M                           # Tamanho máximo de pacote/linha/BLOB aceito pelo servidor
max_connections                 = 300
connect_timeout                 = 30
secure-file-priv                = /mysql/dump/securefile        # Restringe LOAD DATA / SELECT INTO OUTFILE a este diretório
skip-mysqlx                                                     # Desabilita X Protocol (porta 33060). Manter se não usar MySQL Shell com X Protocol ou NoSQL.

# =============================================================================
# PERFORMANCE E MEMÓRIA (otimizado para 16 GB RAM | SSD/NVMe)
# =============================================================================
innodb_buffer_pool_size         = 10G                           # ~62% da RAM total. Recomendado 50-70% para servidor dedicado
innodb_buffer_pool_instances    = 8                             # 1 instância por GB (máx 64). 8 instâncias para 10G reduz contenção de mutex
innodb_log_buffer_size          = 32M                           # Buffer de escrita do redo log antes de flush em disco
innodb_file_per_table           = ON                             # [default=ON] Cada tabela em seu próprio .ibd — facilita manutenção e recuperação
innodb_flush_method             = O_DIRECT                      # Bypass do OS page cache — evita double buffering (buffer pool + OS cache). Recomendado no Linux
innodb_flush_log_at_trx_commit  = 1                             # ACID: flush do redo log a cada commit. Com sync_binlog=1 = zero perda de dados
innodb_io_capacity              = 1000                          # IOPS para tarefas em background (flush, purge). SSD: 1000-2000 | NVMe: 4000-8000
innodb_io_capacity_max          = 2000                          # Pico de IOPS em background sob pressão. Mínimo 2x innodb_io_capacity
innodb_stats_on_metadata        = 0                             # [default=OFF] Desativa recalculo de stats em SHOW TABLE STATUS, SHOW INDEX etc.

thread_cache_size               = 50                            # Threads em cache para reutilização — reduz overhead de criação de thread
table_open_cache                = 4000                          # File descriptors abertos para tabelas (compartilhado entre threads)
table_definition_cache          = 2000                          # Cache de definições de tabelas no Data Dictionary

tmp_table_size                  = 128M                          # Tamanho máximo de temp tables em memória (por sessão). Acima disso: gravado em disco
max_heap_table_size             = 128M                          # Tamanho máximo de tabelas MEMORY/HEAP. Manter igual a tmp_table_size
sort_buffer_size                = 4M                            # Buffer por sessão para ORDER BY. Alocado sob demanda
join_buffer_size                = 4M                            # Buffer por sessão para JOINs sem índice (block nested-loop)
read_buffer_size                = 2M                            # Buffer por sessão para full table scan (leitura sequencial)
read_rnd_buffer_size            = 4M                            # Buffer por sessão para leitura de rows após sort

# =============================================================================
# SERVER LOGS
# =============================================================================
log-error                       = /mysql/log/log_mysql.err      # Error log: startup, shutdown, erros críticos e warnings
log-timestamps                  = SYSTEM                        # Timezone dos timestamps nos logs. Alternativa: UTC para ambientes multi-região
log_error_verbosity             = 3                             # 1=erros | 2=erros+warnings | 3=+notas. Nível 3 recomendado na fase inicial

log_output                      = FILE                          # Destino dos logs: FILE (arquivo) ou TABLE (tabelas mysql.general_log / slow_log)

# General log: registra TODAS as queries — alto impacto de I/O. Uso pontual para auditoria.
# Habilitar sem restart: SET GLOBAL general_log = 1;
general_log                     = 0
general_log_file                = /mysql/audit/general.log

# Slow query log: registra queries que excedem long_query_time.
# Habilitar sem restart: SET GLOBAL slow_query_log = 1;
slow_query_log                  = 0
slow_query_log_file             = /mysql/audit/slow_query.log
long_query_time                 = 7                             # Segundos. Queries acima deste limite são registradas no slow log

# =============================================================================
# BINARY LOG
# =============================================================================
log-bin                         = /mysql/log/mysql-bin          # Habilita binary log. Necessário para GTID, replicação e PITR (Point-in-Time Recovery)
log-bin-index                   = /mysql/log/mysql-bin          # Arquivo índice que lista os binary logs ativos
binlog_format                   = ROW                           # Formato ROW: obrigatório para GTID — replica dados reais linha a linha
sync_binlog                     = 1                             # Sincroniza binlog em disco a cada commit. Com innodb_flush_log_at_trx_commit=1 = zero perda de dados
binlog_expire_logs_seconds      = 432000                        # Retenção de binlog: 432000s = 5 dias. Substitui expire_logs_days (removida no 8.0+)

# =============================================================================
# REPLICAÇÃO E GTID
# Configuração de canais de replicação (CHANGE REPLICATION SOURCE TO, etc.)
# será realizada pós-instalação. Por ora, apenas GTID habilitado.
# =============================================================================
gtid_mode                       = ON                            # GTID ativo. ENUM: OFF(0) | OFF_PERMISSIVE(1) | ON_PERMISSIVE(2) | ON(3)
enforce_gtid_consistency        = ON                            # Rejeita statements incompatíveis com GTID (ex: CREATE TABLE ... SELECT)

[client]
port                            = 3306
socket                          = /mysql/data/mysql.sock
