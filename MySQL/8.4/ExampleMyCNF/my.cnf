
# =============================================================================
# my.cnf - MySQL 8.0 LTS
# Servidor: ALESC - Novo servidor MySQL 8.0 | RHEL 9.7
# Hardware: 16 GiB RAM
# Estrutura de discos:
#   Disk 2 (200GB) → /mysql/data
#   Disk 3 (50GB)  → /mysql/innodb/{redo,undo,doublewrite}
#   Disk 4 (50GB)  → /mysql/innodb/temp
#   Disk 5 (50GB)  → /mysql/audit
#   Disk 6 (50GB)  → /mysql/log  (binlog + errorlog)
#   Disk 7 (50GB)  → /mysql/dump/securefile + /mysql/scripts
# =============================================================================

[mysqld]
# =============================================================================
# CORE / PATHS - DIRETÓRIOS E ARQUIVOS BASE
# =============================================================================
basedir                         = /mysql/mysql                  # ← ajuste se usar symlink diferente
datadir                         = /mysql/data
innodb_data_home_dir            = /mysql/data
pid-file                        = /run/mysqld/mysqld.pid
socket                          = /mysql/data/mysql.sock
plugin_dir                      = /usr/lib64/mysql/plugin       # Avaliar a necessidade dessa variável

# =============================================================================
# INNODB PATHS - Lista explícita de diretórios permitidos ao InnoDB (boa prática)
# Onde o InnoDB deve varrer no startup para localizar tablespaces (.ibd) fora do datadir
# =============================================================================
innodb_directories              = /mysql/data:/mysql/innodb:/mysql/log:/mysql/audit:/mysql/dump

# Atenção: innodb_undo_directory, innodb_log_group_home_dir e innodb_doublewrite_dir devem ser definidos ANTES do primeiro # mysqld --initialize 
# NÃO podem ser alterados de caminho posteriormente sem procedimento de recovery. 
# Expansão do volume/disco subjacente é segura e transparente ao MySQL.
# =============================================================================
# INNODB REDO
# =============================================================================
innodb_log_group_home_dir       = /mysql/innodb/redo            # REDO fica em /mysql/data/#innodb_redo (não use innodb_log_group_home_dir) Monte o Disk 3 em /mysql/data/#innodb_redo para isolar o redo.
innodb_redo_log_capacity        = 4G                            # baixa carga → não precisa de 12G

# =============================================================================
# INNODB UNDO 
# =============================================================================
innodb_undo_directory           = /mysql/innodb/undo
innodb_undo_tablespaces         = 4                             # bom paralelismo e truncamento

# =============================================================================
# INNODB DOUBLEWRITE
# =============================================================================
innodb_doublewrite_dir          = /mysql/innodb/doublewrite
innodb_doublewrite              = ON

# =============================================================================
# INNODB TEMP / TMPDIR
# =============================================================================
innodb_tmpdir                   = /mysql/innodb/temp
innodb_temp_tablespaces_dir     = /mysql/innodb/temp            # session temp tables (MySQL 8+)
tmpdir                          = /mysql/innodb/temp
innodb_temp_data_file_path      = /mysql/innodb/temp/ibtmp1:12M:autoextend:max:10G  # Temp tablespace (ibtmp1) pode crescer porém o limite é bom

# =============================================================================
# Controla crescimento exagerado de tabelas temporárias em memória (por sessão)
# =============================================================================
tmp_table_size                  = 256M
max_heap_table_size             = 256M

# =============================================================================
# === CHARACTER SET / COLLATION
# =============================================================================
character_set_server            = utf8mb4
collation_server                = utf8mb4_general_ci

server-id                       = 1
user                            = mysql
default-storage-engine          = innodb
authentication_policy           = cachinh_sha2_password                #substitui default_authentication_plugin no 8.4
#federated                      # Se NÃO usa FEDERATED, é recomendavel desabilitar (reduz superfície de )
skip-mysqlx                     # skip-mysqlx: desabilita o plugin X Protocol (porta 33060), manter se não usar MySQL Shell com X Protocol ou conexões NoSQL.
max_allowed_packet              = 64M
lc_messages_dir                 = /mysql/mysql/share   # ajuste se não for tarball (verifique com mysqld --verbose --help)
lc_messages_dir                 = /usr/share/mysql     # lc_messages_dir ajustado: MySQL 8.4 no RHEL 10 usa /usr/share/mysql (sem o sufixo -8.0 que existia em versões anteriores do pacote RPM)
lc_messages_dir                 = /usr/share/mysql-8.0 # entender o qual a melhor configuração   

# =============================================================================
# CONEXÕES
# =============================================================================
max_connections                 = 300
connect_timeout                 = 30

# =============================================================================
# VARIÁVEIS COMENTADAS - AVALIAR CONFORME NECESSIDADE
# =============================================================================
#validate_password.check_user_name    = ON
#validate_password.length             = 8
#validate_password.mixed_case_count   = 1
#validate_password.number_count       = 1
#validate_password.policy             = MEDIUM
#validate_password.special_char_count = 1

# =============================================================================
# PERFORMANCE E MEMÓRIA (otimizado para 16 GB RAM total)
# =============================================================================
# Distribuição de memória:
#   innodb_buffer_pool_size  =  8G  # ~62% da RAM → deixa ~6 GB para SO + conexões + overhead
#   innodb_redo_log_capacity =  4G  — redo log
#   tmp_table_size / max_heap_table_size = 256M cada
#   sort_buffer_size         =  4M  × max_connections (alocado por sessão)
#   SO + conexões + overhead ≈  4G reservados
# =============================================================================
innodb_buffer_pool_size         = 10G
innodb_buffer_pool_instances    = 8
innodb_log_buffer_size          = 64M
innodb_file_per_table           = ON                # Cada tabela em seu próprio .ibd
innodb_flush_method             = O_DIRECT          # melhor performance em Linux moderno, evita double buffering com OS cache
  
thread_cache_size               = 50
table_open_cache                = 4000
table_definition_cache          = 2000

# =============================================================================
# Buffers por sessão (alocados sob demanda, não fixos)
# =============================================================================
sort_buffer_size                = 4M
join_buffer_size                = 4M
read_buffer_size                = 2M
read_rnd_buffer_size            = 4M

# =============================================================================
# INNODB - PERFORMANCE E DURABILIDADE
# =============================================================================
innodb_flush_log_at_trx_commit  = 1          # ACID completo (recomendado)
innodb_io_capacity              = 200        # Ajuste conforme IOPS do storage ou deixar o MySQL auto-tunar ou adicionar depois se precisar
innodb_io_capacity_max          = 400
innodb_stats_on_metadata        = OFF        # Reduz I/O em SHOW TABLE STATUS etc.

# =============================================================================
# LOG DE ERRO 
# =============================================================================
log-error                       = /mysql/log/log_mysql.err
log-timestamps                  = SYSTEM
log_error_verbosity             = 3          # 1=erros, 2=erros+avisos, 3=+notas

# =============================================================================
# GENERAL LOG E SLOW QUERY LOG (Disk 5)
# ATENÇÃO: general_log = ON em produção gera volume MUITO alto de I/O.
# =============================================================================
log_output                      = FILE
general_log_file                = /mysql/audit/general.log
general_log                     = ON 

slow_query_log                  = ON
slow_query_log_file             = /mysql/audit/slow_query.log
long_query_time                 = 15

# =============================================================================
# LOG BINÁRIO 
# =============================================================================
log-bin                         = /mysql/log/mysql-bin
log-bin-index                   = /mysql/log/mysql-bin.index
binlog_format                   = ROW
sync_binlog                     = 1
binlog_expire_logs_seconds      = 432000     # Retenção de binlog: 5 dias

# =============================================================================
# DUMP E IMPORT SEGURO 
# =============================================================================
secure-file-priv                = /mysql/dump/securefile

# =============================================================================
# REPLICAÇÃO E GTID
# =============================================================================
gtid_mode                       = ON
enforce_gtid_consistency        = ON

[client]
port                            = 3306
socket                          = /mysql/data/mysql.sock